generator client {
  provider = "prisma-client-js"
  previewFeatures = ["filteredRelationCount"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Item {
  id Int @id

  name_de String
  name_en String
  name_es String
  name_fr String

  icon   Icon? @relation(fields: [iconId], references: [id])
  iconId Int?

  rarity  String  @default("")
  type    String  @default("")
  subtype String?
  weight  String?
  value   Int     @default(0)
  level   Int     @default(0)

  unlocksSkin Skin[]
  unlocksSkinIds Int[]
  recipeOutput Recipe[]
  ingredient IngredientItem[]

  removedFromApi Boolean @default(false)

  current_de Revision @relation("current_de", fields: [currentId_de], references: [id], onDelete: Cascade)
  currentId_de String @unique
  
  current_en Revision @relation("current_en", fields: [currentId_en], references: [id], onDelete: Cascade)
  currentId_en String @unique
  
  current_es Revision @relation("current_es", fields: [currentId_es], references: [id], onDelete: Cascade)
  currentId_es String @unique
  
  current_fr Revision @relation("current_fr", fields: [currentId_fr], references: [id], onDelete: Cascade)
  currentId_fr String @unique

  history ItemHistory[]
  
  lastCheckedAt  DateTime   @default(now())

  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt

  version Int @default(0)
}

model Icon {
  id Int @id
  signature String

  items Item[]
  skills Skill[]
  skins Skin[]
}

model ItemHistory {
  itemId Int
  revisionId String

  item Item @relation(fields: [itemId], references: [id], onDelete: Cascade)
  revision Revision @relation(fields: [revisionId], references: [id], onDelete: Cascade)

  @@id([itemId, revisionId])
}

model Skill {
  id Int @id
  
  name_de String
  name_en String
  name_es String
  name_fr String

  icon   Icon? @relation(fields: [iconId], references: [id])
  iconId Int?


  removedFromApi Boolean @default(false)

  current_de Revision @relation("current_de", fields: [currentId_de], references: [id], onDelete: Cascade)
  currentId_de String @unique
  
  current_en Revision @relation("current_en", fields: [currentId_en], references: [id], onDelete: Cascade)
  currentId_en String @unique
  
  current_es Revision @relation("current_es", fields: [currentId_es], references: [id], onDelete: Cascade)
  currentId_es String @unique
  
  current_fr Revision @relation("current_fr", fields: [currentId_fr], references: [id], onDelete: Cascade)
  currentId_fr String @unique

  history SkillHistory[]
  
  lastCheckedAt  DateTime   @default(now())

  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt

  version Int @default(0)
}

model SkillHistory {
  skillId Int
  revisionId String

  skill Skill @relation(fields: [skillId], references: [id], onDelete: Cascade)
  revision Revision @relation(fields: [revisionId], references: [id], onDelete: Cascade)

  @@id([skillId, revisionId])
}

model Skin {
  id Int @id
  
  name_de String
  name_en String
  name_es String
  name_fr String

  icon   Icon? @relation(fields: [iconId], references: [id])
  iconId Int?

  rarity  String  @default("")
  type    String  @default("")
  subtype String?
  weight  String?

  unlockedByItems Item[]

  removedFromApi Boolean @default(false)
  
  current_de Revision @relation("current_de", fields: [currentId_de], references: [id], onDelete: Cascade)
  currentId_de String @unique
  
  current_en Revision @relation("current_en", fields: [currentId_en], references: [id], onDelete: Cascade)
  currentId_en String @unique
  
  current_es Revision @relation("current_es", fields: [currentId_es], references: [id], onDelete: Cascade)
  currentId_es String @unique
  
  current_fr Revision @relation("current_fr", fields: [currentId_fr], references: [id], onDelete: Cascade)
  currentId_fr String @unique

  history SkinHistory[]
  
  lastCheckedAt  DateTime   @default(now())

  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt

  version Int @default(0)
}

model SkinHistory {
  skinId Int
  revisionId String

  skin Skin @relation(fields: [skinId], references: [id], onDelete: Cascade)
  revision Revision @relation(fields: [revisionId], references: [id], onDelete: Cascade)

  @@id([skinId, revisionId])
}

model Recipe {
  id Int @id

  type        String
  rating      Int
  disciplines String[]

  outputCount   Int
  timeToCraftMs Int

  outputItemId Int?
  outputItem   Item? @relation(fields: [outputItemId], references: [id])

  itemIngredients IngredientItem[]
    
  removedFromApi Boolean @default(false)
  
  currentRevision   Revision @relation("current", fields: [currentRevisionId], references: [id], onDelete: Cascade)
  currentRevisionId String @unique

  history Revision[]

  lastCheckedAt  DateTime   @default(now())

  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt

  version Int @default(0)
}

model IngredientItem {
  recipeId Int
  itemId   Int

  count Int

  Recipe Recipe @relation(fields: [recipeId], references: [id], onDelete: Cascade)
  Item   Item   @relation(fields: [itemId], references: [id], onDelete: Cascade)

  @@id([recipeId, itemId])
}

model Revision {
  id String @id @default(uuid())

  data String
  description String?

  language Language

  build Build @relation(fields: [buildId], references: [id])
  buildId Int
  
  createdAt DateTime @default(now())

  // items
  currentItem_de Item? @relation("current_de")
  currentItem_en Item? @relation("current_en")
  currentItem_es Item? @relation("current_es")
  currentItem_fr Item? @relation("current_fr")
  itemHistory ItemHistory[]
  
  // skills
  currentSkill_de Skill? @relation("current_de")
  currentSkill_en Skill? @relation("current_en")
  currentSkill_es Skill? @relation("current_es")
  currentSkill_fr Skill? @relation("current_fr")
  skillHistory SkillHistory[]
  
  // skins
  currentSkin_de Skin? @relation("current_de")
  currentSkin_en Skin? @relation("current_en")
  currentSkin_es Skin? @relation("current_es")
  currentSkin_fr Skin? @relation("current_fr")
  skinHistory SkinHistory[]

  // recipes
  currentRecipe Recipe? @relation("current")
  recipeHistory Recipe[]
}

model Build {
  id Int @id

  revisions Revision[]
  
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt
}

model Job {
  id String @id @default(uuid())
  
  priority Int @default(1)
  type String
  data Json

  state JobState @default(Queued)
  output String @default("")

  flags String[] @default([])

  cron String?
  
  scheduledAt DateTime @default(now())
  startedAt DateTime?
  finishedAt DateTime?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum Language {
  de
  en
  es
  fr
}

enum JobState {
  Queued
  Running
  Success
  Error
}
