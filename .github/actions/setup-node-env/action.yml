name: Setup Node.js
description: Composite task to set up the Node.js environment used in CI

inputs:
  node-version:
    description: Version of Node.js
    required: true
    default: 20
  cache-key:
    description: The cache key used for turbo caches or 'false' to disable caching
    required: false
    default: 'false'

runs:
  using: composite
  steps:
    # https://github.com/actions/virtual-environments/issues/1187
    - name: tune linux network
      shell: bash
      run: sudo ethtool -K eth0 tx off rx off
    - uses: actions/setup-node@v4
      with:
        node-version: ${{ inputs.node-version }}
        cache: npm
        registry-url: 'https://registry.npmjs.org'
    - name: Ensure NPM_VERSION is set
      if: env.NPM_VERSION == ''
      shell: bash
      run: exit 1
    - name: Install npm
      shell: bash
      run: |
        npm install --global npm@${{ env.NPM_VERSION }}
        npm -v
    - name: Install dependencies
      shell: bash
      run: npm ci
    - name: Cache turbo
      if: inputs.cache-key != 'false'
      uses: actions/cache@v4
      with:
        path: ./.turbo/cache
        key: turbo2-cache-${{ runner.os }}-${{ inputs.cache-key }}-${{ github.sha }}
        restore-keys: |
          turbo2-cache-${{ runner.os }}-${{ inputs.cache-key }}-
          turbo2-cache-${{ runner.os }}-
